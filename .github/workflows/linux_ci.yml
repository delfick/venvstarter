---

name: Tests on Linux

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: [3.7, 3.8, 3.9, "3.10", "3.11"]

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Get pyenv
        uses: gabrielfalcao/pyenv-action@v8

      - name: Cache Python
        id: python_cache
        uses: actions/cache@v2
        with:
          key: python3.6.13_3.7.10_3.8.10_3.9.5_3.10.13_3.11.6
          path: |
            /opt/hostedtoolcache/pyenv_root

      - name: Install python versions
        if: steps.python_cache.outputs.cache-hit != 'true'
        run: |
          set -e

          pyenv --version

          pyenv install 3.7.10
          pyenv install 3.8.10
          pyenv install 3.9.5
          pyenv install 3.10.13
          pyenv install 3.11.6

          pyenv rehash

      - name: Find python versions
        run: |
          set -e

          pyenv versions
          V37=$(pyenv whence python3.7)
          V38=$(pyenv whence python3.8)
          V39=$(pyenv whence python3.9)
          V310=$(pyenv whence python3.10)
          V311=$(pyenv whence python3.11)

          ROOT=$(pyenv root)

          cat <<EOF > pythons.json
          {
            "python3.7": "$ROOT/versions/$V37/bin/python",
            "python3.8": "$ROOT/versions/$V38/bin/python",
            "python3.9": "$ROOT/versions/$V39/bin/python",
            "python3.10": "$ROOT/versions/$V310/bin/python"
            "python3.11": "$ROOT/versions/$V311/bin/python"
          }
          EOF

      - name: Found pythons
        run: |
          cat pythons.json

      - name: Install venvstarter
        run: |
          python3 -m pip install -e ".[tests]"

      - name: Run the tests
        run: |
          ./test.sh
